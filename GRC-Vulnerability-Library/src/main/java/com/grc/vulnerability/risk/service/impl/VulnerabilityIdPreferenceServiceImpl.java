package com.grc.vulnerability.risk.service.impl;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import com.grc.vulnerability.common.utils.MapperUtils;
import com.grc.vulnerability.risk.dao.VulnerabilityIdPreferenceRepository;
import com.grc.vulnerability.risk.dto.VulnerabilityIdPreferenceDTO;
import com.grc.vulnerability.risk.dto.VulnerabilityPreferenceDTO;
import com.grc.vulnerability.risk.entity.VulnerabilityPreference;
import com.grc.vulnerability.risk.exception.ResourceNotFoundException;
import com.grc.vulnerability.risk.service.VulnerabilityIdPreferenceService;


@SuppressWarnings("unused")
@Service
public class VulnerabilityIdPreferenceServiceImpl implements VulnerabilityIdPreferenceService {

	@Autowired
	private VulnerabilityIdPreferenceRepository idPreferenceRepo;	

	@Override
	public List<VulnerabilityPreference> getAllVulnerabilityIdPreferenceByActiveflag() {
		return this.idPreferenceRepo.findAllByActiveflag();
	}

	

	@Override
	public VulnerabilityPreference getVulnerabilityIdPreferenceById(long seriesId) {
		return idPreferenceRepo.findById(seriesId)
				.orElseThrow(() -> new ResourceNotFoundException("VULNERABILITY ID Preference not found with  Id----> " + seriesId));
	}	
	

	@Override
	public int findNewIdPreferenceCountByStatusFlag(String preferenceModule) {
		return this.idPreferenceRepo.findNewIdPreferenceCountByStatusFlag(preferenceModule);
	}

	@Override
	public int getVulnerabilityIdPreferenceCountByActiveflag(String preferenceModule) {
		return this.idPreferenceRepo.getVulnerabilityIdPreferenceCountByModule(preferenceModule);
	}
	
	
	@Override
	public VulnerabilityPreference getVulnerabilityIdPreferenceByModule(String preferenceModule) {		
		VulnerabilityPreference idPreference =  idPreferenceRepo.getVulnerabilityIdPreferenceByModule(preferenceModule);
		return idPreference;				
	}
	

	@Override
	public VulnerabilityIdPreferenceDTO createVulnerabilityIdPreference(VulnerabilityIdPreferenceDTO preferenceDto, String userName) {
		int temCount =  this.idPreferenceRepo.findNewIdPreference(preferenceDto.getPreferenceOganization(), preferenceDto.getPreferenceYear(), preferenceDto.getRunningSeries());
		if (temCount > 0) {
			throw new ResourceNotFoundException(" ID Preference found with  Module ----------->"+ preferenceDto.getPreferenceModule().trim() );
			}
		int tempCount = getVulnerabilityIdPreferenceCountByActiveflag(preferenceDto.getPreferenceModule().trim());
		if(tempCount <= 0) {
			VulnerabilityPreferenceDTO atDto = MapperUtils.mapToTargetClass(preferenceDto, VulnerabilityPreferenceDTO.class);
			//	apDto.setStatus("Initiated");
				atDto.setDeleteFlag("N");
				atDto.setActiveFlag("Y");
				atDto.setStatus("Y");
				atDto.setCreatedBy(userName);		
				VulnerabilityPreference atFinding = idPreferenceRepo.save(MapperUtils.mapToTargetClass(atDto, VulnerabilityPreference.class));
			return MapperUtils.mapToTargetClass(atFinding, VulnerabilityIdPreferenceDTO.class);
		} else {		
			throw new ResourceNotFoundException("ID Preference found with  Module ----> " + preferenceDto.getPreferenceModule().trim());
		//	AMAuditPreferenceDTO idPreferenceDto = MapperUtils.mapToTargetClass(getAuditIdPreferenceByModule(preferenceDto.getPreferenceModule().trim()), AMAuditPreferenceDTO.class);
		//	return idPreferenceDto;
		}
	}

	@Override
	public List<VulnerabilityPreference> saveAllVulnerabilityIdPreference(List<VulnerabilityPreference> preferenceList) {
		return this.idPreferenceRepo.saveAll(preferenceList);
	}

	@Override
	public VulnerabilityIdPreferenceDTO updateVulnerabilityIdPreference(VulnerabilityIdPreferenceDTO preferenceDto, String userName) {			
		VulnerabilityPreference preference = getVulnerabilityIdPreferenceById(preferenceDto.getSeriesId());
		if (preference.getPreferenceModule().equals(preferenceDto.getPreferenceModule())) {
			VulnerabilityIdPreferenceDTO preferenceLog = deleteVulnerabilityIdPreference(preferenceDto, userName);
			VulnerabilityPreferenceDTO atPreferenceDto = MapperUtils.mapToTargetClass(preferenceDto, VulnerabilityPreferenceDTO.class);
			atPreferenceDto.setActiveFlag("Y");
			atPreferenceDto.setDeleteFlag("N");
		//	atPreferenceDto.setStatus("Y");
			atPreferenceDto.setCreatedBy(preference.getCreatedBy());
			atPreferenceDto.setModifiedBy(userName);			
			VulnerabilityPreference atFinding = idPreferenceRepo.save(MapperUtils.mapToTargetClass(atPreferenceDto, VulnerabilityPreference.class));		
			return MapperUtils.mapToTargetClass(atFinding, VulnerabilityIdPreferenceDTO.class);
			}else 
			{
			throw new ResourceNotFoundException("ID Preference not found with  Module ----> " + preferenceDto.getPreferenceModule().trim());
			}
	}
	
	

	@Override
	public VulnerabilityIdPreferenceDTO deleteVulnerabilityIdPreference(VulnerabilityIdPreferenceDTO preferenceDto, String userName) {	
		VulnerabilityPreference preference = getVulnerabilityIdPreferenceById(preferenceDto.getSeriesId());
		preference.setDeleteFlag("D");
		preference.setActiveFlag("N");
		preference.setStatus("N");
		preference.setModifiedBy(userName);
		return MapperUtils.mapToTargetClass(preference, VulnerabilityIdPreferenceDTO.class);
	}



	@Override
	public String findNewIdPreference(VulnerabilityIdPreferenceDTO preferenceDto) {
		int tempCount =  this.idPreferenceRepo.findNewIdPreference(preferenceDto.getPreferenceOganization(), preferenceDto.getPreferenceYear(), preferenceDto.getRunningSeries());
		if (tempCount > 0) {
			return "ID not Available";
		}else {		
		return "ID Available";
		}
	}

}
